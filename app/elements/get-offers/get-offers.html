<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="get-offers">
  <template>
  <style>
  :host {
    display: block;
  }
  </style>
  <iron-ajax handle-as="json"></iron-ajax>
</template>
<script>
(function() {
  'use strict';

  Polymer({
    is: 'get-offers',

    properties: {
      foo: {
        type: String,
        value: 'get-offers',
        notify: true
      },
      web3: {
        type: Object
      }
    },

    attached: function() {
      var web3 = document.querySelector('#web3wallet');
      //var mapb = document.querySelector('#mapb');
      //mapb.map.invalidateSize();
      web3.addEventListener('web3-ready', function() {
        console.log('web3 ready');
        this.web3 = web3.web3;
        this.getdata();
      }.bind(this));
      //console.log(web3wallet.web3);
    },

    getdata: function() {
      console.log('getting data');
      var self = this;
      app.helpers.getfile('../../contracts/localsInOut.json', function(err, contractjson) {
        var MyContract = self.web3.eth.contract(contractjson.abi);
        var myContractInstance = MyContract.at(contractjson.address);
        //var totalprop = 1;
        var totaloffers = myContractInstance.numOffers().toNumber();
        console.log('we have ', totaloffers, ' offers');
        self.data = [];
        for (var i = totaloffers - 1; i >= 0; i--) {
          var _description = null;
          //Things[i];
          var offers = myContractInstance.offers(i);
          console.log(offers[3]);
          self.loadIPFSdata(offers[3], function(object) {
            console.log(object);
          });
        };
      });
    },

    loadIPFSdata: function(ipfshash, fn) {
      var ajax = document.querySelector('iron-ajax');
      ajax.url = 'https://gateway.ipfs.io/ipfs/'+ipfshash;
      ajax.generateRequest();
      ajax.addEventListener('response', function(e) {
        console.log(e);
        fn(e);
      }.bind(this));
    }

});
})();
</script>
</dom-module>
